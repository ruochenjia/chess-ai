/*
 * Copyright (c) 2020, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 *----------------------------------------------------------------------------*/
var Chess=function(r){var e="b",n="w",t=-1,o="p",i="b",u="k",f="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",l=["1-0","0-1","1/2-1/2","*"],a={b:[16,32,17,15],w:[-16,-32,-17,-15]},s={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},c=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],p=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],v={p:0,n:1,b:2,r:3,q:4,k:5},g={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},h={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},d={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},E={w:[{square:d.a1,flag:h.QSIDE_CASTLE},{square:d.h1,flag:h.KSIDE_CASTLE}],b:[{square:d.a8,flag:h.QSIDE_CASTLE},{square:d.h8,flag:h.KSIDE_CASTLE}]},b=new Array(128),m={w:t,b:t},_=n,A={w:0,b:0},y=t,S=0,C=1,I=[],T={},w={};function P(r){void 0===r&&(r=!1),b=new Array(128),m={w:t,b:t},_=n,A={w:0,b:0},y=t,S=0,C=1,I=[],r||(T={}),w={},D(k())}function R(){for(var r=[],e={},n=function(r){r in w&&(e[r]=w[r])};I.length>0;)r.push(J());for(n(k());r.length>0;)z(r.pop()),n(k());w=e}function L(){O(f)}function O(r,o){void 0===o&&(o=!1);var i=r.split(/\s+/),u=i[0],f=0;if(!N(r).valid)return!1;P(o);for(var l=0;l<u.length;l++){var a=u.charAt(l);if("/"===a)f+=8;else if(-1!=="0123456789".indexOf(a))f+=parseInt(a,10);else{var s=a<"a"?n:e;Q({type:a.toLowerCase(),color:s},rr(f)),f++}}return _=i[1],i[2].indexOf("K")>-1&&(A.w|=h.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(A.w|=h.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(A.b|=h.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(A.b|=h.QSIDE_CASTLE),y="-"===i[3]?t:d[i[3]],S=parseInt(i[4],10),C=parseInt(i[5],10),D(k()),!0}function N(r){var e="No errors.",n="FEN string must contain six space-delimited fields.",t="6th field (move number) must be a positive integer.",o="5th field (half move counter) must be a non-negative integer.",i="4th field (en-passant square) is invalid.",u="3rd field (castling availability) is invalid.",f="2nd field (side to move) is invalid.",l="1st field (piece positions) does not contain 8 '/'-delimited rows.",a="1st field (piece positions) is invalid [consecutive numbers].",s="1st field (piece positions) is invalid [invalid piece].",c="1st field (piece positions) is invalid [row too large].",p="Illegal en-passant square",v=r.split(/\s+/);if(6!==v.length)return{valid:!1,error_number:1,error:n};if(isNaN(v[5])||parseInt(v[5],10)<=0)return{valid:!1,error_number:2,error:t};if(isNaN(v[4])||parseInt(v[4],10)<0)return{valid:!1,error_number:3,error:o};if(!/^(-|[abcdefgh][36])$/.test(v[3]))return{valid:!1,error_number:4,error:i};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(v[2]))return{valid:!1,error_number:5,error:u};if(!/^(w|b)$/.test(v[1]))return{valid:!1,error_number:6,error:f};var g=v[0].split("/");if(8!==g.length)return{valid:!1,error_number:7,error:l};for(var h=0;h<g.length;h++){for(var d=0,E=!1,b=0;b<g[h].length;b++)if(isNaN(g[h][b])){if(!/^[prnbqkPRNBQK]$/.test(g[h][b]))return{valid:!1,error_number:9,error:s};d+=1,E=!1}else{if(E)return{valid:!1,error_number:8,error:a};d+=parseInt(g[h][b],10),E=!0}if(8!==d)return{valid:!1,error_number:10,error:c}}return"3"==v[3][1]&&"w"==v[1]||"6"==v[3][1]&&"b"==v[1]?{valid:!1,error_number:11,error:p}:{valid:!0,error_number:0,error:e}}function k(){for(var r=0,e="",o=d.a8;o<=d.h1;o++){if(null==b[o])r++;else{r>0&&(e+=r,r=0);var i=b[o].color,u=b[o].type;e+=i===n?u.toUpperCase():u.toLowerCase()}o+1&136&&(r>0&&(e+=r),o!==d.h1&&(e+="/"),r=0,o+=8)}var f="";A.w&h.KSIDE_CASTLE&&(f+="K"),A.w&h.QSIDE_CASTLE&&(f+="Q"),A.b&h.KSIDE_CASTLE&&(f+="k"),A.b&h.QSIDE_CASTLE&&(f+="q"),f=f||"-";var l=y===t?"-":rr(y);return[e,_,f,l,S,C].join(" ")}function q(r){for(var e=0;e<r.length;e+=2)"string"==typeof r[e]&&"string"==typeof r[e+1]&&(T[r[e]]=r[e+1]);return T}function D(r){I.length>0||(r!==f?(T.SetUp="1",T.FEN=r):(delete T.SetUp,delete T.FEN))}function K(r){var e=b[d[r]];return e?{type:e.type,color:e.color}:null}function Q(r,e){if(!("type"in r)||!("color"in r))return!1;if(-1==="pnbrqkPNBRQK".indexOf(r.type.toLowerCase()))return!1;if(!(e in d))return!1;var n=d[e];return(r.type!=u||m[r.color]==t||m[r.color]==n)&&(b[n]={type:r.type,color:r.color},r.type===u&&(m[r.color]=n),D(k()),!0)}function U(r,e,n,t,i){var u={color:_,from:e,to:n,flags:t,piece:r[e].type};return i&&(u.flags|=h.PROMOTION,u.promotion=i),r[n]?u.captured=r[n].type:t&h.EP_CAPTURE&&(u.captured=o),u}function x(r){function e(r,e,n,t,u){if(r[n].type!==o||0!==X(t)&&7!==X(t))e.push(U(r,n,t,u));else for(var f=["q","r",i,"n"],l=0,a=f.length;l<a;l++)e.push(U(r,n,t,u,f[l]))}var n=[],t=_,u=er(t),f={b:1,w:6},l=d.a8,c=d.h1,p=!1,v=void 0===r||!("legal"in r)||r.legal;if(void 0!==r&&"square"in r){if(!(r.square in d))return[];l=c=d[r.square],p=!0}for(var g=l;g<=c;g++)if(136&g)g+=7;else{var E=b[g];if(null!=E&&E.color===t)if(E.type===o){var S=g+a[t][0];if(null==b[S]){e(b,n,g,S,h.NORMAL);S=g+a[t][1];f[t]===X(g)&&null==b[S]&&e(b,n,g,S,h.BIG_PAWN)}for(C=2;C<4;C++){136&(S=g+a[t][C])||(null!=b[S]&&b[S].color===u?e(b,n,g,S,h.CAPTURE):S===y&&e(b,n,g,y,h.EP_CAPTURE))}}else for(var C=0,I=s[E.type].length;C<I;C++){var T=s[E.type][C];for(S=g;!(136&(S+=T));){if(null!=b[S]){if(b[S].color===t)break;e(b,n,g,S,h.CAPTURE);break}if(e(b,n,g,S,h.NORMAL),"n"===E.type||"k"===E.type)break}}}if(!p||c===m[t]){if(A[t]&h.KSIDE_CASTLE){var w=(P=m[t])+2;null!=b[P+1]||null!=b[w]||B(u,m[t])||B(u,P+1)||B(u,w)||e(b,n,m[t],w,h.KSIDE_CASTLE)}if(A[t]&h.QSIDE_CASTLE){var P;w=(P=m[t])-2;null!=b[P-1]||null!=b[P-2]||null!=b[P-3]||B(u,m[t])||B(u,P-1)||B(u,w)||e(b,n,m[t],w,h.QSIDE_CASTLE)}}if(!v)return n;var R=[];for(g=0,I=n.length;g<I;g++)z(n[g]),M(t)||R.push(n[g]),J();return R}function $(r,e){var n="";if(r.flags&h.KSIDE_CASTLE)n="O-O";else if(r.flags&h.QSIDE_CASTLE)n="O-O-O";else{var t=function(r,e){for(var n=x({legal:!e}),t=r.from,o=r.to,i=r.piece,u=0,f=0,l=0,a=0,s=n.length;a<s;a++){var c=n[a].from,p=n[a].to;i===n[a].piece&&t!==c&&o===p&&(u++,X(t)===X(c)&&f++,Y(t)===Y(c)&&l++)}if(u>0)return f>0&&l>0?rr(t):l>0?rr(t).charAt(1):rr(t).charAt(0);return""}(r,e);r.piece!==o&&(n+=r.piece.toUpperCase()+t),r.flags&(h.CAPTURE|h.EP_CAPTURE)&&(r.piece===o&&(n+=rr(r.from)[0]),n+="x"),n+=rr(r.to),r.flags&h.PROMOTION&&(n+="="+r.promotion.toUpperCase())}return z(r),W()&&(G()?n+="#":n+="+"),J(),n}function j(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function B(r,t){for(var i=d.a8;i<=d.h1;i++)if(136&i)i+=7;else if(null!=b[i]&&b[i].color===r){var u=b[i],f=i-t,l=f+119;if(c[l]&1<<v[u.type]){if(u.type===o){if(f>0){if(u.color===n)return!0}else if(u.color===e)return!0;continue}if("n"===u.type||"k"===u.type)return!0;for(var a=p[l],s=i+a,g=!1;s!==t;){if(null!=b[s]){g=!0;break}s+=a}if(!g)return!0}}return!1}function M(r){return B(er(r),m[r])}function W(){return M(_)}function G(){return W()&&0===x().length}function F(){return!W()&&0===x().length}function H(){for(var r={},e=[],n=0,t=0,o=d.a8;o<=d.h1;o++)if(t=(t+1)%2,136&o)o+=7;else{var u=b[o];u&&(r[u.type]=u.type in r?r[u.type]+1:1,u.type===i&&e.push(t),n++)}if(2===n)return!0;if(3===n&&(1===r.b||1===r.n))return!0;if(n===r.b+2){var f=0,l=e.length;for(o=0;o<l;o++)f+=e[o];if(0===f||f===l)return!0}return!1}function Z(){for(var r=[],e={},n=!1;;){var t=J();if(!t)break;r.push(t)}for(;;){var o=k().split(" ").slice(0,4).join(" ");if(e[o]=o in e?e[o]+1:1,e[o]>=3&&(n=!0),!r.length)break;z(r.pop())}return n}function z(r){var n=_,i=er(n);if(function(r){I.push({move:r,kings:{b:m.b,w:m.w},turn:_,castling:{b:A.b,w:A.w},ep_square:y,half_moves:S,move_number:C})}(r),b[r.to]=b[r.from],b[r.from]=null,r.flags&h.EP_CAPTURE&&(_===e?b[r.to-16]=null:b[r.to+16]=null),r.flags&h.PROMOTION&&(b[r.to]={type:r.promotion,color:n}),b[r.to].type===u){if(m[b[r.to].color]=r.to,r.flags&h.KSIDE_CASTLE){var f=r.to-1,l=r.to+1;b[f]=b[l],b[l]=null}else if(r.flags&h.QSIDE_CASTLE){f=r.to+1,l=r.to-2;b[f]=b[l],b[l]=null}A[n]=""}if(A[n])for(var a=0,s=E[n].length;a<s;a++)if(r.from===E[n][a].square&&A[n]&E[n][a].flag){A[n]^=E[n][a].flag;break}if(A[i])for(a=0,s=E[i].length;a<s;a++)if(r.to===E[i][a].square&&A[i]&E[i][a].flag){A[i]^=E[i][a].flag;break}y=r.flags&h.BIG_PAWN?"b"===_?r.to-16:r.to+16:t,r.piece===o||r.flags&(h.CAPTURE|h.EP_CAPTURE)?S=0:S++,_===e&&C++,_=er(_)}function J(){var r=I.pop();if(null==r)return null;var n=r.move;m=r.kings,_=r.turn,A=r.castling,y=r.ep_square,S=r.half_moves,C=r.move_number;var t,i,u=_,f=er(_);if(b[n.from]=b[n.to],b[n.from].type=n.piece,b[n.to]=null,n.flags&h.CAPTURE)b[n.to]={type:n.captured,color:f};else if(n.flags&h.EP_CAPTURE){var l;l=u===e?n.to-16:n.to+16,b[l]={type:o,color:f}}n.flags&(h.KSIDE_CASTLE|h.QSIDE_CASTLE)&&(n.flags&h.KSIDE_CASTLE?(t=n.to+1,i=n.to-1):n.flags&h.QSIDE_CASTLE&&(t=n.to-2,i=n.to+1),b[t]=b[i],b[i]=null);return n}function V(r,e){var n=j(r);if(e){var t=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(t)var o=t[1],i=t[2],u=t[3],f=t[4]}for(var l=x(),a=0,s=l.length;a<s;a++){if(n===j($(l[a]))||e&&n===j($(l[a],!0)))return l[a];if(t&&(!o||o.toLowerCase()==l[a].piece)&&d[i]==l[a].from&&d[u]==l[a].to&&(!f||f.toLowerCase()==l[a].promotion))return l[a]}return null}function X(r){return r>>4}function Y(r){return 15&r}function rr(r){var e=Y(r),n=X(r);return"abcdefgh".substring(e,e+1)+"87654321".substring(n,n+1)}function er(r){return r===n?e:n}function nr(r){var e=tr(r);e.san=$(e,!1),e.to=rr(e.to),e.from=rr(e.from);var n="";for(var t in h)h[t]&e.flags&&(n+=g[t]);return e.flags=n,e}function tr(r){var e=r instanceof Array?[]:{};for(var n in r)e[n]="object"==typeof n?tr(r[n]):r[n];return e}function or(r){return r.replace(/^\s+|\s+$/g,"")}function ir(r){for(var e=x({legal:!1}),n=0,t=_,o=0,i=e.length;o<i;o++){if(z(e[o]),!M(t))if(r-1>0)n+=ir(r-1);else n++;J()}return n}return O(void 0===r?f:r),{WHITE:n,BLACK:e,PAWN:o,KNIGHT:"n",BISHOP:i,ROOK:"r",QUEEN:"q",KING:u,SQUARES:function(){for(var r=[],e=d.a8;e<=d.h1;e++)136&e?e+=7:r.push(rr(e));return r}(),FLAGS:g,load:function(r){return O(r)},reset:function(){return L()},moves:function(r){for(var e=x(r),n=[],t=0,o=e.length;t<o;t++)void 0!==r&&"verbose"in r&&r.verbose?n.push(nr(e[t])):n.push($(e[t],!1));return n},ugly_moves:function(r){return x(r)},in_check:function(){return W()},in_checkmate:function(){return G()},in_stalemate:function(){return F()},in_draw:function(){return S>=100||F()||H()||Z()},insufficient_material:function(){return H()},in_threefold_repetition:function(){return Z()},game_over:function(){return S>=100||G()||F()||H()||Z()},validate_fen:function(r){return N(r)},fen:function(){return k()},board:function(){for(var r=[],e=[],n=d.a8;n<=d.h1;n++)null==b[n]?e.push(null):e.push({type:b[n].type,color:b[n].color}),n+1&136&&(r.push(e),e=[],n+=8);return r},pgn:function(r){var e="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\n",n="object"==typeof r&&"number"==typeof r.max_width?r.max_width:0,t=[],o=!1;for(var i in T)t.push("["+i+' "'+T[i]+'"]'+e),o=!0;o&&I.length&&t.push(e);for(var u=function(r){var e=w[k()];void 0!==e&&(r=`${r}${r.length>0?" ":""}{${e}}`);return r},f=[];I.length>0;)f.push(J());var l=[],a="";for(0===f.length&&l.push(u(""));f.length>0;){a=u(a);var s=f.pop();I.length||"b"!==s.color?"w"===s.color&&(a.length&&l.push(a),a=C+"."):a=C+". ...",a=a+" "+$(s,!1),z(s)}if(a.length&&l.push(u(a)),void 0!==T.Result&&l.push(T.Result),0===n)return t.join("")+l.join(" ");var c=function(){return t.length>0&&" "===t[t.length-1]&&(t.pop(),!0)},p=function(r,o){for(var i of o.split(" "))if(i){if(r+i.length>n){for(;c();)r--;t.push(e),r=0}t.push(i),r+=i.length,t.push(" "),r++}return c()&&r--,r},v=0;for(i=0;i<l.length;i++)v+l[i].length>n&&l[i].includes("{")?v=p(v,l[i]):(v+l[i].length>n&&0!==i?(" "===t[t.length-1]&&t.pop(),t.push(e),v=0):0!==i&&(t.push(" "),v++),t.push(l[i]),v+=l[i].length);return t.join("")},load_pgn:function(r,e){var n=void 0!==e&&"sloppy"in e&&e.sloppy;function t(r){return r.replace(/\\/g,"\\")}var o="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\r?\n",i=new RegExp("^(\\[((?:"+t(o)+")|.)*\\])(?:"+t(o)+"){2}"),u=i.test(r)?i.exec(r)[1]:"";L();var f=function(r,e){for(var n="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\r?\n",o={},i=r.split(new RegExp(t(n))),u="",f="",l=0;l<i.length;l++)u=i[l].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),f=i[l].replace(/^\[[A-Za-z]+\s"(.*)"\ *\]$/,"$1"),or(u).length>0&&(o[u]=f);return o}(u,e);for(var a in f)q([a,f[a]]);if(!("1"!==f.SetUp||"FEN"in f&&O(f.FEN,!0)))return!1;for(var s=function(r){return`{${function(r){return Array.from(r).map((function(r){return r.charCodeAt(0)<128?r.charCodeAt(0).toString(16):encodeURIComponent(r).replace(/\%/g,"").toLowerCase()})).join("")}((r=r.replace(new RegExp(t(o),"g")," ")).slice(1,r.length-1))}}`},c=function(r){if(r.startsWith("{")&&r.endsWith("}"))return function(r){return 0==r.length?"":decodeURIComponent("%"+r.match(/.{1,2}/g).join("%"))}(r.slice(1,r.length-1))},p=r.replace(u,"").replace(new RegExp(`({[^}]*})+?|;([^${t(o)}]*)`,"g"),(function(r,e,n){return void 0!==e?s(e):" "+s(`{${n.slice(1)}}`)})).replace(new RegExp(t(o),"g")," "),v=/(\([^\(\)]+\))+?/g;v.test(p);)p=p.replace(v,"");var g=or(p=(p=(p=p.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));g=g.join(",").replace(/,,+/g,",").split(",");for(var h="",d=0;d<g.length-1;d++){var E=c(g[d]);if(void 0===E){if(null==(h=V(g[d],n)))return!1;z(h)}else w[k()]=E}if(void 0!==(E=c(g[g.length-1]))&&(w[k()]=E,g.pop()),h=g[g.length-1],l.indexOf(h)>-1)(function(r){for(var e in r)return!0;return!1})(T)&&void 0===T.Result&&q(["Result",h]);else{if(null==(h=V(h,n)))return!1;z(h)}return!0},header:function(){return q(arguments)},ascii:function(){return function(){for(var r="   +------------------------+\n",e=d.a8;e<=d.h1;e++){if(0===Y(e)&&(r+=" "+"87654321"[X(e)]+" |"),null==b[e])r+=" . ";else{var t=b[e].type;r+=" "+(b[e].color===n?t.toUpperCase():t.toLowerCase())+" "}e+1&136&&(r+="|\n",e+=8)}return r+="   +------------------------+\n",r+"     a  b  c  d  e  f  g  h\n"}()},turn:function(){return _},move:function(r,e){var n=void 0!==e&&"sloppy"in e&&e.sloppy,t=null;if("string"==typeof r)t=V(r,n);else if("object"==typeof r)for(var o=x(),i=0,u=o.length;i<u;i++)if(r.from===rr(o[i].from)&&r.to===rr(o[i].to)&&(!("promotion"in o[i])||r.promotion===o[i].promotion)){t=o[i];break}if(!t)return null;var f=nr(t);return z(t),f},ugly_move:function(r,e){var n=nr(r);return z(r),n},undo:function(){var r=J();return r?nr(r):null},clear:function(){return P()},put:function(r,e){return Q(r,e)},get:function(r){return K(r)},remove:function(r){return function(r){var e=K(r);return b[d[r]]=null,e&&e.type===u&&(m[e.color]=t),D(k()),e}(r)},perft:function(r){return ir(r)},square_color:function(r){if(r in d){var e=d[r];return(X(e)+Y(e))%2==0?"light":"dark"}return null},history:function(r){for(var e=[],n=[],t=(void 0!==r&&"verbose"in r&&r.verbose);I.length>0;)e.push(J());for(;e.length>0;){var o=e.pop();t?n.push(nr(o)):n.push($(o)),z(o)}return n},get_comment:function(){return w[k()]},set_comment:function(r){w[k()]=r.replace("{","[").replace("}","]")},delete_comment:function(){var r=w[k()];return delete w[k()],r},get_comments:function(){return R(),Object.keys(w).map((function(r){return{fen:r,comment:w[r]}}))},delete_comments:function(){return R(),Object.keys(w).map((function(r){var e=w[r];return delete w[r],{fen:r,comment:e}}))}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define((function(){return Chess}));